# Архитектура Gmail Subscription Cleaner

## Обзор системы

Gmail Subscription Cleaner - это Chrome Extension (Manifest V3), построенное по принципам чистой архитектуры с четким разделением ответственности.

## Диаграмма компонентов

```
┌─────────────────────────────────────────────────────────────────┐
│                        Chrome Browser                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Popup Window                          │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  popup.html (UI Structure)                        │  │   │
│  │  │  - Экран авторизации                              │  │   │
│  │  │  - Главный экран со списком отправителей          │  │   │
│  │  │  - Экран настроек                                 │  │   │
│  │  │  - Модальные окна                                 │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │                         ↕                                 │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  popup.css (Styles)                               │  │   │
│  │  │  - Адаптивный дизайн (400-600px)                 │  │   │
│  │  │  - Современная цветовая схема                     │  │   │
│  │  │  - Анимации и transitions                         │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │                         ↕                                 │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  popup.js (PopupController)                       │  │   │
│  │  │  - Управление UI состоянием                       │  │   │
│  │  │  - Обработка пользовательских действий            │  │   │
│  │  │  - Коммуникация с Background Worker               │  │   │
│  │  │  - Рендеринг списков                              │  │   │
│  │  │  - Поиск и фильтрация (debounce 300ms)           │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↕                                   │
│                  chrome.runtime.sendMessage()                    │
│                              ↕                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │          Background Service Worker                       │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  background.js                                     │  │   │
│  │  │  ┌─────────────────────────────────────────────┐  │  │   │
│  │  │  │  OAuth 2.0 Manager                          │  │  │   │
│  │  │  │  - chrome.identity.getAuthToken()           │  │  │   │
│  │  │  │  - Управление токенами                       │  │  │   │
│  │  │  │  - Обновление токенов                        │  │  │   │
│  │  │  └─────────────────────────────────────────────┘  │  │   │
│  │  │  ┌─────────────────────────────────────────────┐  │  │   │
│  │  │  │  Message Handler                             │  │  │   │
│  │  │  │  - checkAuth                                 │  │  │   │
│  │  │  │  - authenticate                              │  │  │   │
│  │  │  │  - loadEmails                                │  │  │   │
│  │  │  │  - deleteEmails                              │  │  │   │
│  │  │  └─────────────────────────────────────────────┘  │  │   │
│  │  │  ┌─────────────────────────────────────────────┐  │  │   │
│  │  │  │  Email Processor                             │  │  │   │
│  │  │  │  - Загрузка списка ID писем                 │  │  │   │
│  │  │  │  - Batch загрузка деталей                   │  │  │   │
│  │  │  │  - Анализ и группировка                     │  │  │   │
│  │  │  │  - Кэширование результатов                  │  │  │   │
│  │  │  └─────────────────────────────────────────────┘  │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↕                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  Utils Modules                           │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ gmail-api.js │  │  parser.js   │  │ storage.js   │  │   │
│  │  │              │  │              │  │              │  │   │
│  │  │ GmailAPI     │  │ EmailParser  │  │ StorageManager│ │   │
│  │  │ - request()  │  │ - analyze()  │  │ - get()      │  │   │
│  │  │ - batch()    │  │ - extract()  │  │ - set()      │  │   │
│  │  │ - retry()    │  │ - filter()   │  │ - cache()    │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↕                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Chrome Storage API                          │   │
│  │  - whitelist (белый список)                             │   │
│  │  - emailAnalysis (кэш анализа)                          │   │
│  │  - settings (настройки)                                 │   │
│  │  - actionHistory (история действий)                     │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↕
                    HTTPS (OAuth 2.0)
                              ↕
┌─────────────────────────────────────────────────────────────────┐
│                      Gmail API (Google)                          │
│  - /messages (список писем)                                     │
│  - /messages/{id} (детали письма)                               │
│  - /messages/batchDelete (удаление)                             │
│  - Rate Limits: 250 units/user/second                           │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Авторизация
```
User Click → Popup → Background → chrome.identity → Google OAuth → Token
                                                                      ↓
                                                        Cache Token (55 min)
```

### 2. Загрузка писем
```
User Action → Popup → Background → Gmail API
                                      ↓
                                  Get Message IDs (batch 100)
                                      ↓
                                  Get Message Details (batch 50)
                                      ↓
                                  Parser.analyze()
                                      ↓
                                  Group by Sender
                                      ↓
                                  Storage.cache()
                                      ↓
                                  Return to Popup
                                      ↓
                                  Render List
```

### 3. Удаление писем
```
User Click → Confirm Modal → Popup → Background
                                        ↓
                                  Check Whitelist
                                        ↓
                                  Gmail API.batchDelete()
                                        ↓
                                  Update Cache
                                        ↓
                                  Notify Popup
                                        ↓
                                  Update UI
```

## Модули и их ответственность

### Popup Layer (Presentation)
**Файлы**: `popup/popup.html`, `popup/popup.css`, `popup/popup.js`

**Ответственность**:
- Отображение UI
- Обработка пользовательского ввода
- Валидация на клиенте
- Управление состоянием UI
- Коммуникация с Background Worker

**Не делает**:
- Прямые запросы к Gmail API
- Бизнес-логику
- Хранение данных

### Background Layer (Business Logic)
**Файлы**: `background/background.js`

**Ответственность**:
- OAuth авторизация
- Координация запросов к Gmail API
- Обработка сообщений от Popup
- Управление кэшем
- Обработка ошибок

**Не делает**:
- Рендеринг UI
- Прямое взаимодействие с пользователем

### Utils Layer (Data & Services)
**Файлы**: `utils/gmail-api.js`, `utils/parser.js`, `utils/storage.js`

#### GmailAPI (gmail-api.js)
**Ответственность**:
- HTTP запросы к Gmail API
- Обработка ошибок API
- Rate limiting
- Retry логика
- Batch requests

#### EmailParser (parser.js)
**Ответственность**:
- Парсинг писем
- Извлечение метаданных
- Группировка по отправителям
- Поиск unsubscribe ссылок
- Фильтрация и сортировка

#### StorageManager (storage.js)
**Ответственность**:
- CRUD операции с chrome.storage
- Управление белым списком
- Кэширование
- История действий
- Настройки

## Принципы архитектуры

### 1. Separation of Concerns
Каждый модуль отвечает за одну задачу:
- UI отделен от бизнес-логики
- API запросы изолированы в wrapper
- Хранилище абстрагировано

### 2. Single Responsibility
Каждый класс/функция имеет одну ответственность:
- `PopupController` - только UI
- `GmailAPI` - только API запросы
- `EmailParser` - только парсинг

### 3. Dependency Injection
Модули не создают зависимости, а получают их:
```javascript
// Background использует utils
const gmailApi = new GmailAPI();
const parser = new EmailParser();
const storage = new StorageManager();
```

### 4. Async/Await
Вся асинхронная работа через async/await:
```javascript
async function loadEmails() {
  const messages = await gmailApi.getMessages();
  const analysis = parser.analyze(messages);
  await storage.saveAnalysis(analysis);
}
```

### 5. Error Handling
Обработка ошибок на каждом уровне:
```javascript
try {
  await operation();
} catch (error) {
  console.error('Technical:', error);
  showUserMessage('Понятное сообщение');
}
```

## Оптимизации производительности

### 1. Кэширование
- Результаты анализа кэшируются на 30 минут
- OAuth токены кэшируются на 55 минут
- Избегаем повторных запросов к API

### 2. Batch Requests
- Загрузка писем батчами по 100
- Детали писем батчами по 50
- Удаление до 1000 писем за раз

### 3. Rate Limiting
- Задержка 100мс между запросами
- Соблюдение квот Gmail API (250 units/sec)
- Retry с exponential backoff

### 4. Debouncing
- Поиск с debounce 300мс
- Избегаем лишних рендеров

### 5. Lazy Loading
- Детали писем загружаются по требованию
- Виртуализация для больших списков (TODO)

## Безопасность

### 1. OAuth 2.0
- Официальный flow через chrome.identity
- Токены не хранятся в коде
- Автоматическое обновление токенов

### 2. Permissions
Минимальные необходимые права:
- `storage` - для настроек
- `identity` - для OAuth
- `gmail.modify` - для удаления
- `gmail.readonly` - для чтения

### 3. Data Protection
- Белый список защищает важные письма
- Подтверждение перед удалением
- Не логируем содержимое писем

### 4. Input Validation
- Валидация email адресов
- Санитизация пользовательского ввода
- Защита от XSS

## Масштабируемость

### Текущие ограничения
- 500 писем за загрузку (настраивается)
- 100 отправителей без виртуализации
- 30 минут кэш

### Планы расширения
- Виртуальный скроллинг для >100 элементов
- Web Workers для тяжелых операций
- IndexedDB для больших объемов данных
- Инкрементальная загрузка

## Тестируемость

### Unit Tests (планируется)
- Тестирование каждого модуля изолированно
- Моки для Gmail API
- Тестирование парсера на разных данных

### Integration Tests (планируется)
- Тестирование взаимодействия модулей
- E2E тесты через Puppeteer

### Manual Testing
- См. `TESTING.md` для сценариев
- Проверка на реальных данных

## Мониторинг и отладка

### Логирование
```javascript
console.log('Info:', data);      // Информация
console.error('Error:', error);  // Ошибки
console.warn('Warning:', msg);   // Предупреждения
```

### DevTools
- Console для логов
- Network для API запросов
- Performance для профилирования
- Storage для проверки кэша

### Метрики (планируется)
- Время загрузки
- Количество запросов
- Размер кэша
- Ошибки API

---

**Версия архитектуры**: 1.0  
**Последнее обновление**: 2026-01-06  
**Статус**: Production Ready (MVP)

